install
keyboard 'us'
rootpw --iscrypted $5$Kcpk1AQYkYSYkV0u$ZSOCZPc41epdcUX8z6KLPuwiuJJGUHzSyxjWkhOiBw2
timezone Asia/Shanghai
lang en_US
auth  --useshadow  --passalgo=sha512
text
firstboot --disable
selinux --disabled
services --disabled="chronyd"
reboot --eject
bootloader --location=mbr
zerombr
%include /tmp/part-include

%packages --nobase --excludedocs
@core --nodefaults
@prod_1 --nodefaults
%end

%pre
disk=`cat /proc/mdstat | grep 'active raid' | awk '{print $1}' | head -n 1`
if [ -z "$disk" ] ; then
	disk=`lsblk  | grep disk | grep -v 'fd' | awk '{print $1}'  | head -n 1`
fi

vg_uuid=`cat /proc/sys/kernel/random/uuid  | awk -F '-' '{print $1}'`

vg_before=`vgdisplay | grep 'Name'| awk '{print $3}'`
for i in ${vg_before}
do
	echo -e "y\ny\n" | vgremove $i
done

/usr/sbin/parted -s /dev/${disk} mklabel gpt
cat > /tmp/part-include << EOF
part biosboot --fstype=biosboot --size=1 --ondisk=${disk}
part /boot --fstype="ext4" --size=512 --ondisk=${disk}
part / --fstype="ext4" --size=25600 --ondisk=${disk}
part /usr/local/yunanbao --fstype="ext4" --size=4096 --ondisk=${disk}
part pv.01 --size=1 --grow --ondisk=${disk}
volgroup ${vg_uuid}_vg_root pv.01
logvol  /opt  --vgname=${vg_uuid}_vg_root  --size=1  --grow  --name=lv_opt
EOF
%end

%post
source  /etc/profile
hostname="SecFox"
echo "${hostname}" > /etc/hostname
echo > /etc/redhat-release
echo > /etc/issue


mv -f /var/log /opt/log
ln -s /opt/log /var/log

systemctl enable rsyslog.service
systemctl disable rpcbind.socket
systemctl enable denyhosts.service

echo "GRUB2_PASSWORD=grub.pbkdf2.sha512.10000.B73891CABE081FE1124B88F6F82168480DD115A33FE9781E517905E59E51800C1075EC8CBE16D0D8EDA8359CBA7C5D68A35F279A0729886181089EC5EF695A2E.89871F263065C215AC6D8A3C90C9362AF820ACFEE132AE2EC5A31C19D8F34C98651DAF798A074682C7E1D1E80E16CF2DD8C00BCD1C1193307490DF0CF02FEDA6" > /boot/grub2/user.cfg

sed -i "s/GRUB_CMDLINE_LINUX=\"/GRUB_CMDLINE_LINUX=\"console=ttyS0,115200n8 console=tty0 biosdevname=1 /g"  /etc/default/grub

grub2-mkconfig -o /boot/grub2/grub.cfg
sed -i "s/CentOS/${hostname}/g" /boot/grub2/grub.cfg

ls /etc/sysconfig/network-scripts/ifcfg-* | grep -v 'ifcfg-lo'  | xargs rm -rf
sh /usr/local/yunanbao/lcm/bin/init
if [ -f /etc/hardware_model ] ; then
	eth_init=`grep 'eth' /etc/hardware_model | awk -F '[<>]' '{print $3}' | head -1`
	eth_init_biosdevname=`biosdevname  -i ${eth_init}`
else
	eth_init=`ip a | grep 'BROADCAST'  | awk '{print $2}' | cut -d ":" -f 1  | head -1`
	eth_init_biosdevname=`biosdevname  -i ${eth_init}`
fi
if [ -z "$eth_init_biosdevname" ] ; then
	tmp_cfg="/etc/sysconfig/network-scripts/ifcfg-${eth_init}"
	[ ! -f "$tmp_cfg" ] && touch $tmp_cfg
	if [ $? -eq 0 ] ; then
		echo "TYPE=Ethernet" >$tmp_cfg
		echo "BOOTPROTO=dhcp" >>$tmp_cfg
		echo "DEVICE=${eth_init}" >>$tmp_cfg
		echo "ONBOOT=yes" >>$tmp_cfg
	fi
else
	tmp_cfg="/etc/sysconfig/network-scripts/ifcfg-${eth_init_biosdevname}"
	[ ! -f "$tmp_cfg" ] && touch $tmp_cfg
	if [ $? -eq 0 ] ; then
		echo "TYPE=Ethernet" >$tmp_cfg
		echo "BOOTPROTO=none" >>$tmp_cfg
		echo "DEVICE=${eth_init_biosdevname}" >>$tmp_cfg
		echo "ONBOOT=yes" >>$tmp_cfg
		echo "IPADDR=10.0.0.1" >>$tmp_cfg
		echo "NETMASK=255.255.255.0" >>$tmp_cfg
	fi
fi

echo "nameserver 223.5.5.5" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf
sed -i "/UseDNS/c\UseDNS no" /etc/ssh/sshd_config
sed -i "/GSSAPIAuthentication/c\#GSSAPIAuthentication no" /etc/ssh/sshd_config
sed -i "/GSSAPICleanupCredentials/c\#GSSAPICleanupCredentials yes" /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/'  /etc/ssh/sshd_config

/usr/bin/chmod +x /etc/rc.d/rc.local
chattr +i /etc/shadow
%end
